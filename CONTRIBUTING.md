# Creating modules for Terraform

This repository contains code for an application that is published using the Application Builder Platform (ABP).

## Module Standards

For best practices and information on developing with Terraform, see the [I&A Module Standards](https://aws-ia.github.io/standards-terraform/)

## Contributing Code

In order to contibute code to this repository, you must submit a *[Pull Request](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request)*. To do so, you must *[fork](https://docs.github.com/en/get-started/quickstart/fork-a-repo)* this repostiory, make your changes in your forked version and submit a *Pull Request*.

### Version Bump Automation

This repository uses automated version bumping based on PR titles. When your PR is merged to main, the version bump action will automatically create a new version based on your **PR title**:

- **Patch version** (default): Regular PRs will increment the patch version (e.g., v0.2.6 → v0.2.7)
- **Minor version**: Include `[Minor Release]` at the beginning of your PR title to increment the minor version (e.g., v0.2.6 → v0.3.0)
- **Major version**: Include `[Major Release]` at the beginning of your PR title to increment the major version (e.g., v0.2.6 → v1.0.0)

**Examples:**
- `Add new SFTP connector feature` → Patch version bump
- `[Minor Release] Add new SFTP connector feature` → Minor version bump
- `[Major Release] Redesign transfer server architecture` → Major version bump

### Transfer Server Module Synchronization

> :warning: **IMPORTANT**: Do not modify files directly in the `modules/transfer-server/` directory.

The transfer-server module is automatically synchronized from the root module files. When you create or update a PR that modifies any of the following root files:

- `main.tf`
- `outputs.tf`
- `variables.tf`
- `versions.tf`

The GitHub Action will automatically copy these files to `modules/transfer-server/` and update the module documentation. **Any changes made directly to files in `modules/transfer-server/` will be overwritten** during this synchronization process.

Always make your changes to the root module files, not the sub-module files.

## Writing Documentation

> :bangbang: **Do not manually update README.md files**.

README.md files are automatically generated by pulling in content from other files and using terraform-docs. For instructions, including a fill-in-the-blank content template, see [Create readmes for Terraform-based Partner Solutions.](https://aws-ia-us-west-2.s3.us-west-2.amazonaws.com/docs/content/index.html#/lessons/8rpYWWL59M7dcS-NsjYmaISUu-L_UqEv)

## Checks and Validation

Pull Requests (PRs) submitted against this repository undergo a series of static and functional checks.

> :exclamation: Note: Failures during funtional or static checks will prevent a pull request from being accepted.

It is a best practice to perform these checks locally prior to submitting a pull request.

## Customizing static and functional test

Details about the static and functional test can be found at `./project_automation/{test-name}/entrypoint.sh`.
TIPS: **do not** modify the `./project_automation/{test-name}/entrypoint.sh`, instead use the helper script located at `.config/{test-name}/`

## Checks Performed

- TFLint
- tfsec
- Markdown Lint
- Checkov
- Terratest

> :bangbang: The readme.md file will be created after all checks have completed successfuly, it is recommended that you install terraform-docs locally in order to preview your readme.md file prior to publication.

## Install the required tools

Prerequisites:

- [Python](https://docs.python.org/3/using/index.html)
- [Pip](https://pip.pypa.io/en/stable/installation/)
- [golang](https://go.dev/doc/install) (for macos you can use `brew`)
- [tflint](https://github.com/terraform-linters/tflint)
- [tfsec](https://aquasecurity.github.io/tfsec/v1.0.11/)
- [Markdown Lint](https://github.com/markdownlint/markdownlint)
- [Checkov](https://www.checkov.io/2.Basics/Installing%20Checkov.html)
- [terraform-docs](https://github.com/terraform-docs/terraform-docs)
- [coreutils](https://www.gnu.org/software/coreutils/)

## Performing Checks manually

Preparation

```sh
terraform init
terraform validate
```

## Checks

### tflint

```sh
tflint --init --config ${PROJECT_PATH}/.config/.tflint.hcl
tflint --force --config ${PROJECT_PATH}/.config/.tflint.hcl
```

### tfsec

```sh
tfsec . --config-file ${PROJECT_PATH}/.config/.tfsec.yml
```

### Markdown Lint

```sh
mdl --config ${PROJECT_PATH}/.config/.mdlrc .header.md examples/*/.header.md
```

### Checkov

```sh
checkov --config-file ${PROJECT_PATH}/.config/.checkov.yml
```

### Terratest

Include tests to validate your examples/<> root modules, at a minimum. This can be accomplished with usually only slight modifications to the [boilerplate test provided in this template](./test/examples\_basic\_test.go)

```sh
# from the root of the repository
cd test
go mod init github.com/aws-ia/terraform-project-ephemeral
go mod tidy
go install github.com/gruntwork-io/terratest/modules/terraform
go test -timeout 45m
```

## Documentation

### terraform-docs

```sh
# from the root of the repository
terraform-docs --config ${PROJECT_PATH}/.config/.terraform-docs.yaml --lockfile=false ./
```
