name: Sync Transfer Server Module
permissions:
  contents: write

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'main.tf'
      - 'outputs.tf'
      - 'variables.tf'
      - 'versions.tf'

jobs:
  sync-module:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Copy Terraform files to transfer-server module
        run: |
          cp main.tf outputs.tf variables.tf versions.tf modules/transfer-server/

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Generate terraform-docs
        uses: terraform-docs/gh-actions@v1.2.0
        with:
          working-dir: modules/transfer-server
          output-file: README.md
          output-method: inject
          git-push: false  # Important: Don't push here, we'll do it in the next step

      - name: Commit all changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add modules/transfer-server/
          git diff --staged --quiet || (git commit -m "chore: sync transfer-server module files and update documentation" && git push origin ${{ github.head_ref }})