# Transfer Web App Module

This module creates web application resources for AWS Transfer Family.

## Overview

This module creates and configures a Transfer Family web app and related dependencies:

- IAM Identity Center organizational or account instance integration
- S3 Access Grants instance and locations management
- S3 Access Grants creation for fine-grained permissions
- Transfer Family web app provisioning, configuration, and customization

## Features

- **Browser-based interface** providing secure access to Amazon S3 data
- **Authentication** through AWS IAM Identity Center, supporting existing identity provider federation, multi-factor authentication
- **Granular permission management** through S3 Access Grants for user and group-level access control with configurable paths and permissions
- **KMS encryption support** for S3 buckets using SSE-KMS encryption
- **Built-in compliance** including HIPAA eligibility, PCI DSS compliance, SOC 1, 2, and 3, and ISO certifications
- **Customization options** including logo, favicon, and personalized browser page title
- **Flexible S3 Access Grants configuration** supporting new or existing instances and locations
- **Flexible IAM role configuration** supporting new or existing IAM roles

## Quick Start

```hcl
module "transfer_web_app" {
  source = "aws-ia/transfer-family/aws//modules/transfer-web-app"

  # Required Identity Center Configuration
  identity_center_instance_arn = "arn:aws:sso:::instance/ssoins-1234567890abcdef"
  identity_store_id           = "d-1234567890"

  # Identity Center Users and Groups
  identity_center_users = [
    {
      username = "admin"
      access_grants = [{
        s3_path    = "bucket/*"
        permission = "READWRITE"
      }]
    }
  ]

  identity_center_groups = [
    {
      group_name = "Analysts"
      access_grants = [{
        s3_path    = "bucket/*"
        permission = "READ"
      }]
    }
  ]

  tags = {
    Environment = "Demo"
    Project     = "File Portal"
  }
}
```

## S3 Path Examples

Access grants support various path patterns:

- `bucket/*` - All objects in the bucket
- `bucket/reports*` - Prefix within a bucket
- `bucket/data/logs*` - Prefix within prefix
- `bucket/data/file.txt` - Specific object

## Important Configuration Notes

### Same S3 Bucket Region Requirements
S3 buckets referenced in access grants must be located in the same AWS region where this module is deployed. 

### S3 CORS Configuration
When using the Transfer Web App with S3 buckets, you must configure CORS (Cross-Origin Resource Sharing) on your S3 buckets to allow the web app to access the data. The `AllowedOrigins` in your S3 bucket CORS policy must include the URL of the newly created web app, which can be obtained from the module's `web_app_endpoint` output.

For detailed CORS configuration requirements, see the [AWS Transfer Family documentation](https://docs.aws.amazon.com/transfer/latest/userguide/access-grant-cors.html).


## S3 Access Grants Configuration

The module supports two configuration modes for S3 Access Grants:

### 1. Create New Instance and Location for All Buckets (Default - Recommended)
```hcl
# Creates new instance and location with scope for all buckets (default)
s3_access_grants_location_new = "s3://"  # Default value - recommended approach
```

### 2. Use Existing Instance and Location
```hcl
# Uses existing instance and location
# IMPORTANT: Existing S3 Access Grants instance must be associated with 
# IAM Identity Center before creating access grants
s3_access_grants_instance_id         = "instance-id"
s3_access_grants_location_existing   = "location-id"
s3_access_grants_location_new        = null  # Skip location creation
```

For more information about S3 Access Grants locations, see the [AWS documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-grants-location-register.html).

## IAM Role Configuration

The module supports two configuration modes for IAM roles:

### 1. Create New IAM Role (Default)
```hcl
# Creates new IAM role with S3 Access Grants permissions (default)
iam_role_name = "transfer-web-app-role"  # Customize role name if needed
```

### 2. Use Existing IAM Role
```hcl
# Uses existing IAM role - must have S3 Access Grants permissions
existing_web_app_iam_role_arn = "arn:aws:iam::123456789012:role/existing-web-app-role"
```

**Important**: When using an existing IAM role, ensure it has the necessary S3 Access Grants permissions:
- `s3:GetDataAccess`
- `s3:ListCallerAccessGrants` 
- `s3:ListAccessGrantsInstances`

## Key Variables

### Required Variables
- `identity_center_instance_arn` - ARN of Identity Center instance
- `identity_store_id` - ID of Identity Center identity store

### Optional Variables

#### Identity Center Configuration
- `identity_center_users` - List of users with access grants configuration (default: `[]`)
- `identity_center_groups` - List of groups with access grants configuration (default: `[]`)

#### S3 Access Grants Configuration
- `s3_access_grants_instance_id` - ID of existing S3 Access Grants instance (default: `null` - creates new)
- `s3_access_grants_location_new` - Location scope for new location (default: `"s3://"` for all buckets, `null` to skip creation)
- `s3_access_grants_location_existing` - ID of existing location (default: `null`, requires `s3_access_grants_instance_id` for non-null)
- `s3_access_grants_location_iam_role_arn` - ARN of existing IAM role for location (default: `null` - creates new)

#### IAM Configuration
- `existing_web_app_iam_role_arn` - ARN of existing IAM role for web app (default: `null` - creates new)
- `iam_role_name` - Name for IAM role used by web app when creating new role (default: `"transfer-web-app-role"`)

#### Web App Customization
- `logo_file` - Path to logo file for branding (default: `null`)
- `favicon_file` - Path to favicon file (default: `null`)
- `custom_title` - Custom browser page title (default: `null`)
- `provisioned_units` - Number of provisioned web app units (default: `1`). One web app unit allows web app activity from up to 250 unique sessions per 5 minute period. 
  When creating a web app, you provision how many units you will need based on your expected peak workload volumes. 
  Changing your web app units will have an impact on your billing. 
  For more information, see [AWS Transfer Family Pricing](https://aws.amazon.com/aws-transfer-family/pricing/)

#### Tags
- `tags` - Map of tags to assign to resources (default: `{}`)

