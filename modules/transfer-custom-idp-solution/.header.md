# AWS Transfer Family Custom Identity Provider Solution Module

This Terraform module creates a complete custom identity provider solution for AWS Transfer Family using Lambda, DynamoDB, and optionally API Gateway. The module automatically builds Lambda artifacts from the AWS Transfer Family Toolkit GitHub repository.

## Features

- **Lambda-based Identity Provider**: Validates user credentials and returns Transfer Family configuration
- **DynamoDB Storage**: Stores user configurations and identity provider settings
- **Multiple Identity Provider Support**: Cognito, Active Directory, LDAP, public key authentication
- **API Gateway Integration**: Optional REST API for Transfer Family invocation
- **VPC Support**: Optional VPC attachment for Lambda function
- **Automated Build**: CodeBuild automatically builds Lambda artifacts from GitHub
- **Flexible Configuration**: Use existing or create new DynamoDB tables and VPC resources

## Usage

### Basic Usage (Direct Lambda)

```hcl
module "custom_idp" {
  source = "../../modules/transfer-custom-idp-solution"

  name_prefix = "my-sftp"
  
  # DynamoDB tables will be created automatically
  users_table_name              = ""
  identity_providers_table_name = ""
  
  # No VPC attachment
  use_vpc    = false
  create_vpc = false
  
  # Direct Lambda invocation (no API Gateway)
  provision_api = false
  
  tags = {
    Environment = "production"
    Project     = "file-transfer"
  }
}
```

### With API Gateway

```hcl
module "custom_idp" {
  source = "../../modules/transfer-custom-idp-solution"

  name_prefix = "my-sftp"
  
  # Enable API Gateway
  provision_api = true
  
  use_vpc    = false
  create_vpc = false
  
  tags = {
    Environment = "production"
  }
}
```

### With VPC (Create New VPC)

```hcl
module "custom_idp" {
  source = "../../modules/transfer-custom-idp-solution"

  name_prefix = "my-sftp"
  
  # Create new VPC for Lambda
  use_vpc    = true
  create_vpc = true
  vpc_cidr   = "10.0.0.0/16"
  
  provision_api = false
  
  tags = {
    Environment = "production"
  }
}
```

### With Existing VPC

```hcl
module "custom_idp" {
  source = "../../modules/transfer-custom-idp-solution"

  name_prefix = "my-sftp"
  
  # Use existing VPC
  use_vpc            = true
  create_vpc         = false
  vpc_id             = "vpc-12345678"
  subnet_ids         = ["subnet-12345678", "subnet-87654321"]
  security_group_ids = ["sg-12345678"]
  
  provision_api = false
  
  tags = {
    Environment = "production"
  }
}
```

### With Existing DynamoDB Tables

```hcl
module "custom_idp" {
  source = "../../modules/transfer-custom-idp-solution"

  name_prefix = "my-sftp"
  
  # Use existing DynamoDB tables
  users_table_name              = "existing-users-table"
  identity_providers_table_name = "existing-providers-table"
  
  use_vpc       = false
  provision_api = false
  
  tags = {
    Environment = "production"
  }
}
```

## Resources Created

### Always Created
- **Lambda Function**: Custom identity provider handler
- **Lambda Layer**: Python dependencies
- **S3 Bucket**: Stores build artifacts
- **CodeBuild Project**: Builds Lambda artifacts from GitHub
- **IAM Roles**: Lambda execution role, Transfer/API Gateway invocation role
- **IAM Policies**: DynamoDB access, CloudWatch Logs, optional Secrets Manager

### Conditionally Created
- **DynamoDB Tables**: Users and Identity Providers tables (if not using existing)
- **VPC Resources**: VPC, subnets, NAT gateways, security groups (if `create_vpc = true`)
- **API Gateway**: REST API, resources, methods, deployment, stage (if `provision_api = true`)

## Examples

For complete working examples, see:
- [SFTP with Cognito (Lambda)](../../examples/sftp-idp-cognito-lambda) - Direct Lambda invocation
- [SFTP with Cognito (API Gateway)](../../examples/sftp-idp-cognito-api-gateway) - API Gateway integration

### Prerequisites

- AWS CLI configured (required for CodeBuild trigger)
- Internet access for GitHub repository cloning
- Appropriate AWS permissions to create resources
