resource "aws_guardduty_malware_protection_plan" "this" {
  role = aws_iam_role.guardduty_role.arn

  protected_resource {
    s3_bucket {
      bucket_name     = var.s3_bucket_name
      object_prefixes = var.object_prefixes
    }
  }

  actions {
    tagging {
      status = "ENABLED"
    }
  }
}

resource "aws_iam_role" "guardduty_role" {
  name               = "${var.name_prefix}-guardduty-role"
  assume_role_policy = data.aws_iam_policy_document.trust_policy.json
}

resource "aws_iam_role_policy_attachment" "guardduty_policy" {
  role       = aws_iam_role.guardduty_role.name
  policy_arn = aws_iam_policy.guardduty_policy.arn
}

resource "aws_iam_policy" "guardduty_policy" {
  name   = "${var.name_prefix}-guardduty-policy"
  policy = data.aws_iam_policy_document.permissions.json
}
