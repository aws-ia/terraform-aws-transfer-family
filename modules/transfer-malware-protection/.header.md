# Transfer Family Malware Protection Module

This module provides automated malware scanning and smart file routing for AWS Transfer Family servers using GuardDuty.

## Features

- **GuardDuty Integration**: Automatic malware scanning of uploaded files
- **Smart Routing**: Routes files based on scan results (clean, infected, errors)
- **Event-Driven**: EventBridge + optional SQS buffering for reliable processing
- **Threat Notifications**: Optional SNS integration for immediate malware alerts
- **Dead Letter Queue**: Optional DLQ support for failed message processing
- **Configurable**: Customizable destinations, encryption, VPC, and error handling
- **Optional Cleanup**: Delete or retain files in ingestion bucket after processing

## Quick Start

```hcl
module "guardduty_malware_protection" {
  source = "aws-ia/transfer-family/aws//modules/transfer-malware-protection"

  s3_ingest_bucket = {
    bucket_name     = "[ingest-bucket-name]"
    object_prefixes = ["[ingest-prefix-list]"]
  }

  routing_config = {
    "NO_THREATS_FOUND" = "[output-bucket]/[output-prefix]"
    "THREATS_FOUND"    = "[output-bucket]/[output-prefix]"
    "UNSUPPORTED"      = "[output-bucket]/[output-prefix]"
    "ACCESS_DENIED"    = "[output-bucket]/[output-prefix]"
    "FAILED"           = "[output-bucket]/[output-prefix]"
  }
}
```

## Architecture

1. Files uploaded to Transfer Family S3 bucket → GuardDuty scans automatically
2. GuardDuty publishes scan events → EventBridge captures events
3. EventBridge → SQS (optional) → Lambda processes events
4. Lambda routes files to the customizable destinations based on scan results
5. Optional SNS notifications sent when threats are detected
6. Failed events → Dead letter queue (optional)

## Variable Reference

### Required Variables

**`s3_ingest_bucket`** - Source bucket configuration *(required)*
```hcl
s3_ingest_bucket = {
  bucket_name     = "[my-sftp-bucket]"        # Transfer Family S3 bucket name
  object_prefixes = ["prefix1", "prefix2"]      # Prefixes/directories in the same S3 bucket name [my-sftp-bucket] to scan
}
```

### Optional Variables

**`name_prefix`** - Resource naming prefix *(optional, default: `"transfer-malware-protection"`)*
```hcl
name_prefix = "my-malware-protection"       # Prefix for all AWS resources
```

**`routing_config`** - Destination mapping for scan results *(optional, default: all `null`)*
```hcl
routing_config = {
  "NO_THREATS_FOUND" = "[clean-bucket-name]/[clean-prefix]"      # Clean files destination
  "THREATS_FOUND"    = "[quarantine-bucket-name]/[quarantine-prefix]"  # Infected files destination
  "UNSUPPORTED"      = "[error-bucket-name]/[error-prefix]"      # Unsupported types of objects 
  "ACCESS_DENIED"    = "[error-bucket-name]/[access-denied-prefix]"  # Permission issues
  "FAILED"           = "[error-bucket-name]/[failed-prefix]"     # Scan failures
}
```
*Note: If `routing_config` is `null`, files remain in the original ingestion bucket without being moved based on scan results.*

**Note:** When `routing_config` values are `null`, files remain in the ingestion bucket regardless of scan results.

**`delete_processed_file_from_ingest_bucket`** - File cleanup behavior *(optional, default: `false`)*
- `false` (default): Keep original files in ingestion bucket
- `true`: Delete files from ingestion bucket after processing

**`ingest_bucket_kms_key_arn`** - KMS key for ingestion bucket *(optional, default: `null`)*
```hcl
ingest_bucket_kms_key_arn = "arn:aws:kms:region:account:key/key-id"
```

**`create_kms_key_for_lambda_sqs`** - Lambda/SQS encryption *(optional, default: `false`)*
- `false` (default): Use AWS managed keys
- `true`: Create dedicated KMS key for Lambda and SQS

**`create_sqs_dlq`** - Dead letter queue *(optional, default: `false`)*
- `false` (default): No dead letter queue (failed messages are lost)
- `true`: Create DLQ for failed message processing

**`enable_sqs_buffer`** - Event buffering *(optional, default: `true`)*
- `true` (default): Use SQS queue between EventBridge and Lambda for reliability
- `false`: Direct EventBridge to Lambda invocation

**`vpc_subnet_ids`** - Lambda VPC subnets *(optional, default: `null`)*
```hcl
vpc_subnet_ids = ["subnet-12345", "subnet-67890"]  # Private subnets recommended
```

**`vpc_security_group_ids`** - Lambda security groups *(optional, default: `null`)*
```hcl
vpc_security_group_ids = ["sg-12345"]              # Allow S3 and SQS access
```

**`code_signing_config_arn`** - Lambda code signing *(optional, default: `null`)*
```hcl
code_signing_config_arn = "arn:aws:signer:region:account:/signing-profiles/profile-name"
```

**`tags`** - Resource tags *(optional, default: `{}`)*
```hcl
tags = {
  Environment = "Production"
  Project     = "File Security"
  Owner       = "Security Team"
}
```

**`sns_topic_arn_for_threats`** - SNS notifications for malware detection *(optional, default: `null`)*
```hcl
sns_topic_arn_for_threats = "arn:aws:sns:region:account:topic/malware-alerts"
```

**`enable_object_tagging`** - GuardDuty object tagging *(optional, default: `true`)*
- `true` (default): GuardDuty tags scanned objects with scan results
- `false`: Disable GuardDuty automatic object tagging

**Notes:**
- Replace all `[placeholder-values]` in brackets with your actual resource names, ARNs, and configuration values.
- Use `bucket-name` only (no prefix) for bucket root placement
- Set routing destinations to `null` to keep files in ingestion bucket