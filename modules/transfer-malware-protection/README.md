<!-- BEGIN_TF_DOCS -->
# Transfer Family Malware Protection Module

This module provides automated malware scanning, file routing, and threat notifications.

## Features

- **GuardDuty Integration**: Automatic malware scanning of uploaded files
- **Smart Routing**: Routes files based on scan results (clean, infected, errors)
- **Event-Driven**: EventBridge + optional SQS buffering for reliable processing
- **Threat Notifications**: Optional SNS integration for immediate malware alerts
- **Dead Letter Queue**: Optional DLQ support for failed message processing
- **Configurable**: Customizable destinations, encryption, VPC, and error handling
- **Optional Cleanup**: Delete or retain files in ingestion bucket after processing

## Quick Start

```hcl
module "guardduty_malware_protection" {
  source = "aws-ia/transfer-family/aws//modules/transfer-malware-protection"

  s3_ingest_bucket = {
    bucket_name     = "[ingest-bucket-name]"
    object_prefixes = ["[ingest-prefix-list]"]
  }

  routing_config = {
    "NO_THREATS_FOUND" = "[output-bucket]/[output-prefix]"
    "THREATS_FOUND"    = "[output-bucket]/[output-prefix]"
    "UNSUPPORTED"      = "[output-bucket]/[output-prefix]"
    "ACCESS_DENIED"    = "[output-bucket]/[output-prefix]"
    "FAILED"           = "[output-bucket]/[output-prefix]"
  }
}
```

## Architecture

1. Files uploaded to Transfer Family S3 bucket → GuardDuty scans automatically
2. GuardDuty publishes scan events → EventBridge captures events
3. EventBridge → SQS (optional) → Lambda processes events
4. Lambda routes files to the customizable destinations based on scan results
5. Optional SNS notifications sent when threats are detected
6. Failed events → Dead letter queue (optional)

## Variable Reference

### Required Variables

**`s3_ingest_bucket`** - Source bucket configuration *(required)*
```hcl
s3_ingest_bucket = {
  bucket_name     = "[my-sftp-bucket]"        # Transfer Family S3 bucket name
  object_prefixes = ["prefix1", "prefix2"]      # Prefixes/directories in the same S3 bucket name [my-sftp-bucket] to scan
}
```

### Optional Variables

**`name_prefix`** - Resource naming prefix *(optional, default: `"transfer-malware-protection"`)*
```hcl
name_prefix = "my-malware-protection"       # Prefix for all AWS resources
```

**`routing_config`** - Destination mapping for scan results *(optional, default: all `null`)*
```hcl
routing_config = {
  "NO_THREATS_FOUND" = "[clean-bucket-name]/[clean-prefix]"      # Clean files destination
  "THREATS_FOUND"    = "[quarantine-bucket-name]/[quarantine-prefix]"  # Infected files destination
  "UNSUPPORTED"      = "[error-bucket-name]/[error-prefix]"      # Unsupported types of objects
  "ACCESS_DENIED"    = "[error-bucket-name]/[access-denied-prefix]"  # Permission issues
  "FAILED"           = "[error-bucket-name]/[failed-prefix]"     # Scan failures
}
```
*Note: If `routing_config` is `null`, files remain in the original ingestion bucket without being moved based on scan results.*

**Note:** When `routing_config` values are `null`, files remain in the ingestion bucket regardless of the scan results.

**`delete_processed_file_from_ingest_bucket`** - File cleanup behavior *(optional, default: `false`)*
- `false` (default): Keep original files in ingestion bucket
- `true`: Delete files from ingestion bucket after processing

**`ingest_bucket_kms_key_arn`** - KMS key for ingestion bucket *(optional, default: `null`)*
```hcl
ingest_bucket_kms_key_arn = "arn:aws:kms:region:account:key/key-id"
```

**`create_kms_key_for_lambda_sqs`** - Lambda/SQS encryption *(optional, default: `false`)*
- `false` (default): Use AWS managed keys
- `true`: Create dedicated KMS key for Lambda and SQS

**`create_sqs_dlq`** - Dead letter queue *(optional, default: `false`)*
- `false` (default): No dead letter queue (failed messages are lost)
- `true`: Create DLQ for failed message processing

**`enable_sqs_buffer`** - Event buffering *(optional, default: `true`)*
- `true` (default): Use SQS queue between EventBridge and Lambda for reliability
- `false`: Direct EventBridge to Lambda invocation

**`vpc_subnet_ids`** - Lambda VPC subnets *(optional, default: `null`)*
```hcl
vpc_subnet_ids = ["subnet-12345", "subnet-67890"]  # Private subnets recommended
```

**`vpc_security_group_ids`** - Lambda security groups *(optional, default: `null`)*
```hcl
vpc_security_group_ids = ["sg-12345"]              # Allow S3 and SQS access
```

**`code_signing_config_arn`** - Lambda code signing *(optional, default: `null`)*
```hcl
code_signing_config_arn = "arn:aws:signer:region:account:/signing-profiles/profile-name"
```

**`tags`** - Resource tags *(optional, default: `{}`)*
```hcl
tags = {
  Environment = "Production"
  Project     = "File Security"
  Owner       = "Security Team"
}
```

**`sns_topic_arn_for_threats`** - SNS notifications for malware detection *(optional, default: `null`)*
```hcl
sns_topic_arn_for_threats = "arn:aws:sns:region:account:topic/malware-alerts"
```

**`enable_object_tagging`** - GuardDuty object tagging *(optional, default: `true`)*
- `true` (default): GuardDuty tags scanned objects with scan results
- `false`: Disable GuardDuty automatic object tagging

**Notes:**
- Replace all `[placeholder-values]` in brackets with your actual resource names, ARNs, and configuration values.
- Use `bucket-name` only (no prefix) for bucket root placement
- Set routing destinations to `null` to keep files in ingestion bucket

## Requirements

No requirements.

## Providers

| Name | Version |
|------|---------|
| <a name="provider_archive"></a> [archive](#provider\_archive) | n/a |
| <a name="provider_aws"></a> [aws](#provider\_aws) | n/a |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_cloudwatch_event_rule.guardduty_scan_results](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_rule) | resource |
| [aws_cloudwatch_event_target.lambda_target](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_target) | resource |
| [aws_cloudwatch_event_target.sqs_target](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_target) | resource |
| [aws_guardduty_malware_protection_plan.malware_protection_plan](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/guardduty_malware_protection_plan) | resource |
| [aws_iam_role.guardduty_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role.lambda_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy.guardduty_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy) | resource |
| [aws_iam_role_policy.lambda_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy) | resource |
| [aws_kms_alias.lambda_env](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/kms_alias) | resource |
| [aws_kms_key.lambda_env](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/kms_key) | resource |
| [aws_lambda_event_source_mapping.sqs_trigger](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_event_source_mapping) | resource |
| [aws_lambda_function.file_transfer_function](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function) | resource |
| [aws_lambda_permission.allow_eventbridge](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_permission) | resource |
| [aws_sqs_queue.dlq](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sqs_queue) | resource |
| [aws_sqs_queue.guardduty_events](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sqs_queue) | resource |
| [aws_sqs_queue_policy.guardduty_events_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sqs_queue_policy) | resource |
| [archive_file.lambda_zip](https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/file) | data source |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_s3_ingest_bucket"></a> [s3\_ingest\_bucket](#input\_s3\_ingest\_bucket) | S3 bucket and prefixes to protect with GuardDuty malware scanning (ingest bucket) | <pre>object({<br/>    bucket_name     = string<br/>    object_prefixes = list(string)<br/>  })</pre> | n/a | yes |
| <a name="input_code_signing_config_arn"></a> [code\_signing\_config\_arn](#input\_code\_signing\_config\_arn) | ARN of the code signing configuration for Lambda function | `string` | `null` | no |
| <a name="input_create_kms_key_for_lambda_sqs"></a> [create\_kms\_key\_for\_lambda\_sqs](#input\_create\_kms\_key\_for\_lambda\_sqs) | Whether to create a new KMS key for Lambda and SQS encryption | `bool` | `false` | no |
| <a name="input_create_sqs_dlq"></a> [create\_sqs\_dlq](#input\_create\_sqs\_dlq) | Whether to create SQS dead letter queue | `bool` | `false` | no |
| <a name="input_delete_processed_file_from_ingest_bucket"></a> [delete\_processed\_file\_from\_ingest\_bucket](#input\_delete\_processed\_file\_from\_ingest\_bucket) | Whether to delete the file in the ingest bucket after scanning (true) or retain them (false) | `bool` | `false` | no |
| <a name="input_enable_object_tagging"></a> [enable\_object\_tagging](#input\_enable\_object\_tagging) | Whether to tag scanned objects with scan results | `bool` | `true` | no |
| <a name="input_enable_sqs_buffer"></a> [enable\_sqs\_buffer](#input\_enable\_sqs\_buffer) | Enable SQS buffer between EventBridge and Lambda for improved reliability | `bool` | `true` | no |
| <a name="input_ingest_bucket_kms_key_arn"></a> [ingest\_bucket\_kms\_key\_arn](#input\_ingest\_bucket\_kms\_key\_arn) | ARN of KMS key used for S3 bucket encryption | `string` | `null` | no |
| <a name="input_name_prefix"></a> [name\_prefix](#input\_name\_prefix) | Prefix for resource names | `string` | `"transfer-malware-protection"` | no |
| <a name="input_routing_config"></a> [routing\_config](#input\_routing\_config) | Mapping of GuardDuty scan results to S3 destination paths | `map(string)` | <pre>{<br/>  "ACCESS_DENIED": null,<br/>  "FAILED": null,<br/>  "NO_THREATS_FOUND": null,<br/>  "THREATS_FOUND": null,<br/>  "UNSUPPORTED": null<br/>}</pre> | no |
| <a name="input_sns_topic_arn_for_threats"></a> [sns\_topic\_arn\_for\_threats](#input\_sns\_topic\_arn\_for\_threats) | SNS topic ARN to notify when THREATS\_FOUND. If provided, notifications will be sent when malware is detected | `string` | `null` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | Tags to apply to resources | `map(string)` | `{}` | no |
| <a name="input_vpc_security_group_ids"></a> [vpc\_security\_group\_ids](#input\_vpc\_security\_group\_ids) | List of VPC security group IDs for Lambda function | `list(string)` | `null` | no |
| <a name="input_vpc_subnet_ids"></a> [vpc\_subnet\_ids](#input\_vpc\_subnet\_ids) | List of VPC subnet IDs for Lambda function | `list(string)` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_file_transfer_function_arn"></a> [file\_transfer\_function\_arn](#output\_file\_transfer\_function\_arn) | ARN of the file transfer Lambda function |
| <a name="output_guardduty_role_arn"></a> [guardduty\_role\_arn](#output\_guardduty\_role\_arn) | ARN of the GuardDuty IAM role |
| <a name="output_malware_protection_plan_arn"></a> [malware\_protection\_plan\_arn](#output\_malware\_protection\_plan\_arn) | ARN of the GuardDuty malware protection plan |
| <a name="output_sqs_queue_arn"></a> [sqs\_queue\_arn](#output\_sqs\_queue\_arn) | ARN of the SQS queue for GuardDuty events |
<!-- END_TF_DOCS -->