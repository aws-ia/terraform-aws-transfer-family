<!-- BEGIN_TF_DOCS -->
# Transfer Family Malware Protection Module

This module provides automated malware protection for AWS Transfer Family servers using Amazon GuardDuty. When malicious files are detected, they are automatically quarantined to a separate S3 bucket.

## Features

- **GuardDuty Malware Protection**: Automatically scans files uploaded to Transfer Family S3 buckets
- **Automatic Quarantine**: Lambda function moves infected files to quarantine bucket
- **Event-Driven**: Uses EventBridge to trigger quarantine actions on malware detection
- **Secure Configuration**: Includes encryption, X-Ray tracing, and dead letter queues
- **Organized Storage**: Quarantined files are organized by date with proper tagging

## Architecture

1. Files uploaded to Transfer Family S3 bucket are scanned by GuardDuty
2. When malware is detected, GuardDuty publishes a finding event
3. EventBridge rule matches the malware finding and triggers Lambda function
4. Lambda function copies the infected file to quarantine bucket and deletes from source
5. Quarantined files are tagged with metadata for tracking and compliance

## Requirements

No requirements.

## Providers

| Name | Version |
|------|---------|
| <a name="provider_archive"></a> [archive](#provider\_archive) | n/a |
| <a name="provider_aws"></a> [aws](#provider\_aws) | n/a |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_cloudwatch_event_rule.guardduty_scan_results](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_rule) | resource |
| [aws_cloudwatch_event_target.lambda_target](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_target) | resource |
| [aws_cloudwatch_event_target.sqs_target](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_target) | resource |
| [aws_guardduty_malware_protection_plan.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/guardduty_malware_protection_plan) | resource |
| [aws_iam_policy.guardduty_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy) | resource |
| [aws_iam_role.guardduty_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role.lambda_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy.lambda_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy) | resource |
| [aws_iam_role_policy_attachment.guardduty_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_kms_alias.lambda_env](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/kms_alias) | resource |
| [aws_kms_key.lambda_env](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/kms_key) | resource |
| [aws_lambda_event_source_mapping.sqs_trigger](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_event_source_mapping) | resource |
| [aws_lambda_function.quarantine_function](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function) | resource |
| [aws_lambda_permission.allow_eventbridge](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_permission) | resource |
| [aws_sqs_queue.dlq](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sqs_queue) | resource |
| [aws_sqs_queue.guardduty_events](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sqs_queue) | resource |
| [aws_sqs_queue_policy.guardduty_events_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sqs_queue_policy) | resource |
| [archive_file.lambda_zip](https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/file) | data source |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_iam_policy_document.permissions](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.trust_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_name_prefix"></a> [name\_prefix](#input\_name\_prefix) | Prefix for resource names | `string` | n/a | yes |
| <a name="input_s3_ingest_bucket"></a> [s3\_ingest\_bucket](#input\_s3\_ingest\_bucket) | S3 bucket and prefixes to protect with GuardDuty malware scanning (ingest bucket) | <pre>object({<br/>    bucket_name     = string<br/>    object_prefixes = list(string)<br/>  })</pre> | n/a | yes |
| <a name="input_buckets_kms_key_arn"></a> [buckets\_kms\_key\_arn](#input\_buckets\_kms\_key\_arn) | ARN of KMS key used for S3 bucket encryption | `string` | `null` | no |
| <a name="input_code_signing_config_arn"></a> [code\_signing\_config\_arn](#input\_code\_signing\_config\_arn) | ARN of the code signing configuration for Lambda function | `string` | `null` | no |
| <a name="input_create_kms_key_for_lambda_sqs"></a> [create\_kms\_key\_for\_lambda\_sqs](#input\_create\_kms\_key\_for\_lambda\_sqs) | Whether to create a new KMS key for Lambda and SQS encryption | `bool` | `true` | no |
| <a name="input_create_sqs_dlq"></a> [create\_sqs\_dlq](#input\_create\_sqs\_dlq) | Whether to create SQS dead letter queue | `bool` | `true` | no |
| <a name="input_delete_processed_file_from_ingest_bucket"></a> [delete\_processed\_file\_from\_ingest\_bucket](#input\_delete\_processed\_file\_from\_ingest\_bucket) | Whether to delete the file in the ingest bucket after scanning (true) or retain them (false) | `bool` | `false` | no |
| <a name="input_enable_sqs_buffer"></a> [enable\_sqs\_buffer](#input\_enable\_sqs\_buffer) | Enable SQS buffer between EventBridge and Lambda for improved reliability | `bool` | `true` | no |
| <a name="input_routing_config"></a> [routing\_config](#input\_routing\_config) | Mapping of GuardDuty scan results to S3 destination paths | `map(string)` | <pre>{<br/>  "ACCESS_DENIED": null,<br/>  "FAILED": null,<br/>  "NO_THREATS_FOUND": null,<br/>  "THREATS_FOUND": null,<br/>  "UNSUPPORTED": null<br/>}</pre> | no |
| <a name="input_tags"></a> [tags](#input\_tags) | Tags to apply to resources | `map(string)` | `{}` | no |
| <a name="input_vpc_security_group_ids"></a> [vpc\_security\_group\_ids](#input\_vpc\_security\_group\_ids) | List of VPC security group IDs for Lambda function | `list(string)` | `null` | no |
| <a name="input_vpc_subnet_ids"></a> [vpc\_subnet\_ids](#input\_vpc\_subnet\_ids) | List of VPC subnet IDs for Lambda function | `list(string)` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_guardduty_role_arn"></a> [guardduty\_role\_arn](#output\_guardduty\_role\_arn) | ARN of the GuardDuty IAM role |
| <a name="output_malware_protection_plan_arn"></a> [malware\_protection\_plan\_arn](#output\_malware\_protection\_plan\_arn) | ARN of the GuardDuty malware protection plan |
| <a name="output_quarantine_function_arn"></a> [quarantine\_function\_arn](#output\_quarantine\_function\_arn) | ARN of the quarantine Lambda function |
| <a name="output_sqs_queue_arn"></a> [sqs\_queue\_arn](#output\_sqs\_queue\_arn) | ARN of the SQS queue for GuardDuty events |
<!-- END_TF_DOCS -->