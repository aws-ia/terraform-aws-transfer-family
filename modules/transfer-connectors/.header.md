# SFTP Connectors Terraform Module

This repository contains Terraform code which creates resources required to configure a Transfer Family SFTP Connector within AWS.

## Overview

This module creates and configures an SFTP connector with the following features:

- Basic connector setup with SFTP protocol and security policies
- Automated discovery of Host Keys of the remote server (Optional), used to verify server identity at each connection 
- CloudWatch logging configuration

**Note**: You must provide an `access_role` ARN - an IAM role that the connector assumes to access S3 and other AWS services. This module does not create the IAM role for you.

## Quick Start

```hcl
module "transfer_connector" {
  source = "aws-ia/transfer-family/aws//modules/transfer-connectors"

  url         = "sftp://external-server.com"
  access_role = "arn:aws:iam::123456789012:role/transfer-connector-role"
  
  sftp_username    = "sftp-user"
  sftp_private_key = file("~/.ssh/id_rsa")

  tags = {
    Environment = "Dev"
    Project     = "File Transfer"
  }
}
```

## Architecture

### High-Level Architecture

![High-Level Architecture of SFTP connector deployment](https://github.com/aws-ia/terraform-aws-transfer-family/blob/main/images/TF_Connectors.png)

Figure 1: High-Level Architecture of SFTP connector deployment using this Terraform module

## Features

### Transfer Connector Configuration

- Deploy SFTP connectors to connect with remote SFTP servers
- Connector name customization (default: "transfer-connector")
- S3 domain support for storing files 
- AWS Secrets Manager support for storing authentication credentials
- Automated IAM role and policy configuration for logging, and for accessing S3 and Secrets Manager 
- Integration with CloudWatch for logging and monitoring

### Automation Features

- EventBridge scheduler integration for automated file retrieval
- S3 events integration for automated file push

## Security Policy Support

- Standard policies (2023-07 and 2024-03)
- FIPS-compliant policy

## Validation Checks

- SSH host key validation
- Credential configuration verification
- IAM access role validation
- Security policy compatibility checks

## Best Practices

- Enable CloudWatch logging for audit and monitoring purposes
- Choose the security policies that have an overlap with algorithms supported by remote SFTP server (default is TransferSFTPConnectorSecurityPolicy-2024-03)
- Use proper tagging for resources (supported via tags variable)
- Provide the public portion of the remote server's host key(s), as trusted_host_keys
- If the remote server only accepts connections from known IP addresses, get the static IP addresses (output) of connector allowlisted by the server administrator

## Installation

To use this module in your Terraform configuration:

1. Reference the module in your Terraform code:

```hcl
module "transfer_connector" {
  source = "aws-ia/transfer-family/aws//modules/transfer-connectors"

  url         = "sftp://external-server.com"
  access_role = "arn:aws:iam::123456789012:role/transfer-connector-role"
  
  sftp_username    = "sftp-user"
  sftp_private_key = file("~/.ssh/id_rsa")

  tags = {
    Environment = "Dev"
    Project     = "File Transfer"
  }
}
```

2. Initialize your Terraform workspace:

```bash
terraform init
```

3. Review the planned changes:

```bash
terraform plan
```

4. Apply the configuration:

```bash
terraform apply
```

## Basic Usage

### SFTP connector setup

```hcl
module "sftp_connector" {
  source = "aws-ia/transfer-family/aws//modules/transfer-connectors"

  url         = "sftp://external-server.com"
  access_role = "arn:aws:iam::123456789012:role/transfer-connector-role"

  sftp_username    = "sftp-user"
  sftp_private_key = file("~/.ssh/id_rsa")

  trusted_host_keys = [
    "ssh-rsa AAAAB3NzaC1yc2EAAAA..."
  ]

  tags = {
    Environment = "Demo"
    Project     = "File Transfer"
  }
}
```

## Examples for automating file transfers

1. This example demonstrates how to use the SFTP connector to automatically discover and retrieve files from an external SFTP server on a scheduled basis using EventBridge Scheduler and Lambda for dynamic file discovery: https://github.com/aws-ia/terraform-aws-transfer-family/tree/main/examples/sftp-connector-automated-file-retrieve-dynamic

2. This example demonstrates how to use the SFTP connector to automatically retrieve specific files from an external SFTP server on a scheduled basis using EventBridge Scheduler: https://github.com/aws-ia/terraform-aws-transfer-family/tree/main/examples/sftp-connector-automated-file-retrieve-static

3. This example demonstrates how to use the SFTP connector to connect an S3 location to an external SFTP server, and automatically send files that are uploaded to S3: https://github.com/aws-ia/terraform-aws-transfer-family/tree/main/examples/sftp-connector-automated-file-send
