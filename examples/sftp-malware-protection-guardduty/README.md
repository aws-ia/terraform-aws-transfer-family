<!-- BEGIN_TF_DOCS -->
# SFTP Server with GuardDuty Malware Protection Example

This example demonstrates how to deploy an AWS Transfer Family SFTP server with integrated GuardDuty malware protection. It builds on top of the `sftp-public-endpoint-service-managed-S3` example and adds malware scanning capabilities. Files uploaded to the server are automatically scanned for malware and routed to appropriate buckets based on scan results.

## Architecture

This example uses a layered approach:

- **Base Infrastructure**: Leverages the `sftp-public-endpoint-service-managed-S3` example for core SFTP functionality
- **Malware Protection Layer**: Adds GuardDuty malware protection with automated file routing

## Key Features

- **SFTP Server**: Fully configured Transfer Family SFTP server with service-managed users (from base example)
- **Multiple Users**: Supports CSV-based user configuration with multiple SSH keys per user
- **Malware Protection**: GuardDuty malware protection plan for automatic file scanning
- **Smart Routing**: Files are automatically moved based on scan results:
  - Clean files (NO\_THREATS\_FOUND) → Clean bucket
  - Infected files (THREATS\_FOUND) → Quarantine bucket
  - Scan errors (UNSUPPORTED/ACCESS\_DENIED/FAILED)→ Error bucket
- **Event-Driven**: EventBridge and SQS integration for real-time malware detection response
- **Secure Storage**: encrypted S3 buckets with public access blocking and optional versioning

## What Gets Deployed

### Base SFTP Infrastructure (from sftp-public-endpoint-service-managed-S3)

- AWS Transfer Family SFTP server (public endpoint)
- S3 bucket for file ingestion (with KMS encryption)
- Transfer users with SSH key authentication
- CloudWatch logging
- IAM roles and policies

### Malware Protection Components

- GuardDuty malware protection plan
- Lambda function for file quarantine and routing
- EventBridge rule for malware detection events
- SQS queue for event buffering (optional, default: `true`)
- Three additional S3 buckets:
  - Quarantine bucket (for infected files)
  - Clean bucket (for safe files)
  - Error bucket (for scan failures)

## File Flow

1. User uploads file to SFTP server → Ingestion bucket
2. GuardDuty automatically scans the file
3. Based on scan results, Lambda function moves file to:
  - **NO\_THREATS\_FOUND** → Clean bucket
  - **THREATS\_FOUND** → Quarantine bucket
  - **UNSUPPORTED/ACCESS\_DENIED/FAILED** → Error bucket

## Configuration Options

The example uses module defaults for most malware protection settings, which provide secure and reliable operation out of the box. You can customize behavior through these variables:

### File Organization

- **`clean_prefix`**, **`quarantine_prefix`**, **`error_prefix`** (default: `null`): Optional S3 prefixes for organizing files in destination buckets. When null, files are placed at the bucket root.
- **`object_prefixes_to_scan`** (default: `[]`): List of S3 object prefixes in the ingest bucket to scan for malware. Empty list scans all objects in the ingest bucket (corresponds to all user directories). Can be customized in terraform.tfvars to scan only specific directories.

## Module Configuration

The malware protection is configured using the `transfer-malware-protection` module:

```hcl
module "guardduty_malware_protection" {
  source = "../../modules/transfer-malware-protection"

  # Required variables
  name_prefix = var.name_prefix
  s3_ingest_bucket = {
    bucket_name = module.sftp-public-endpoint-service-managed-S3-resources.sftp_bucket_name
    object_prefixes = var.object_prefixes_to_scan
  }

  # Optional variables (using module defaults)
  ingest_bucket_kms_key_arn = module.sftp-public-endpoint-service-managed-S3-resources.kms_key_arn
  tags                      = var.tags

  # Smart routing configuration
  routing_config = {
    "NO_THREATS_FOUND" = var.clean_prefix != null ? "${module.s3_bucket_clean.s3_bucket_id}/${var.clean_prefix}" : module.s3_bucket_clean.s3_bucket_id
    "THREATS_FOUND"    = var.quarantine_prefix != null ? "${module.s3_bucket_quarantine.s3_bucket_id}/${var.quarantine_prefix}" : module.s3_bucket_quarantine.s3_bucket_id
    "UNSUPPORTED"      = var.error_prefix != null ? "${module.s3_bucket_errors.s3_bucket_id}/${var.error_prefix}" : module.s3_bucket_errors.s3_bucket_id
    "ACCESS_DENIED"    = var.error_prefix != null ? "${module.s3_bucket_errors.s3_bucket_id}/${var.error_prefix}" : module.s3_bucket_errors.s3_bucket_id
    "FAILED"           = var.error_prefix != null ? "${module.s3_bucket_errors.s3_bucket_id}/${var.error_prefix}" : module.s3_bucket_errors.s3_bucket_id
  }

  depends_on = [module.sftp-public-endpoint-service-managed-S3-resources]
}
```

### Module Defaults Used

The example leverages these module defaults for the following variables:

- **`delete_processed_file_from_ingest_bucket = false`**: Retains original files in ingestion bucket for audit purposes
- **`create_kms_key_for_lambda_sqs = false`**: Uses AWS managed keys for cost efficiency
- **`create_sqs_dlq = false`**: Simplified error handling for basic use cases
- **`enable_sqs_buffer = true`**: Enables SQS buffering for improved reliability
- **`sns_topic_arn_for_threats = null`**: No SNS notifications by default (can be enabled via terraform.tfvars)
- **`enable_object_tagging = true`**: GuardDuty automatically tags scanned objects with scan results

### Optional Features

Users can customize behavior by adding variables to their `terraform.tfvars`. The examples below show non-default values for demonstration:

```hcl
# AWS Configuration
aws_region = "us-west-2"  # Deploy to different AWS region (default: us-east-1)

# User Management
users_file = "custom-users.csv"  # Use different CSV file for user definitions (default: users.csv)
create_test_user = false  # Skip creating test user (default: true)

# File Organization
clean_prefix = "clean/"  # Add prefix to clean files destination (default: null - root of bucket)
quarantine_prefix = "quarantine/"  # Add prefix to quarantined files (default: null - root of bucket)
error_prefix = "errors/"  # Add prefix to error files (default: null - root of bucket)

# Resource Naming
name_prefix = "my-sftp-malware-protection"  # Custom prefix for resources other than S3 buckets and those created as part of the base infrastructure (default: sftp-malware-protection)

# Malware Protection Settings
sns_topic_arn_for_threats = "arn:aws:sns:us-east-1:123456789012:malware-alerts"  # Enable SNS notifications for malware detection (default: null - no notifications)
enable_object_tagging = false  # Disable GuardDuty automatic object tagging (default: true)
object_prefixes_to_scan = ["user1", "user2", "uploads"]  # Scan only specific directories (default: [] - scan all files)

# Resource Tagging
tags = {  # Override default tags
  Environment = "Development"
  Project     = "File Transfer"
  Owner       = "MyTeam"
}
```

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.5 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 5.95.0 |
| <a name="requirement_random"></a> [random](#requirement\_random) | >= 3.0.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_random"></a> [random](#provider\_random) | >= 3.0.0 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_guardduty_malware_protection"></a> [guardduty\_malware\_protection](#module\_guardduty\_malware\_protection) | ../../modules/transfer-malware-protection | n/a |
| <a name="module_s3_bucket_clean"></a> [s3\_bucket\_clean](#module\_s3\_bucket\_clean) | git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git | v5.0.0 |
| <a name="module_s3_bucket_errors"></a> [s3\_bucket\_errors](#module\_s3\_bucket\_errors) | git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git | v5.0.0 |
| <a name="module_s3_bucket_quarantine"></a> [s3\_bucket\_quarantine](#module\_s3\_bucket\_quarantine) | git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git | v5.0.0 |
| <a name="module_sftp-public-endpoint-service-managed-S3-resources"></a> [sftp-public-endpoint-service-managed-S3-resources](#module\_sftp-public-endpoint-service-managed-S3-resources) | ../sftp-public-endpoint-service-managed-S3 | n/a |

## Resources

| Name | Type |
|------|------|
| [random_pet.name](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/pet) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_aws_region"></a> [aws\_region](#input\_aws\_region) | AWS region | `string` | `"us-east-1"` | no |
| <a name="input_clean_prefix"></a> [clean\_prefix](#input\_clean\_prefix) | S3 prefix for clean files | `string` | `null` | no |
| <a name="input_create_test_user"></a> [create\_test\_user](#input\_create\_test\_user) | Whether to create a test user | `bool` | `true` | no |
| <a name="input_enable_object_tagging"></a> [enable\_object\_tagging](#input\_enable\_object\_tagging) | Whether GuardDuty should tag scanned objects with scan results. Can be overridden in terraform.tfvars | `bool` | `true` | no |
| <a name="input_error_prefix"></a> [error\_prefix](#input\_error\_prefix) | S3 prefix for error files | `string` | `null` | no |
| <a name="input_name_prefix"></a> [name\_prefix](#input\_name\_prefix) | Prefix for resource names | `string` | `"sftp-malware-protection"` | no |
| <a name="input_object_prefixes_to_scan"></a> [object\_prefixes\_to\_scan](#input\_object\_prefixes\_to\_scan) | List of S3 object prefixes to scan for malware. Empty list scans all objects. Can be overridden in terraform.tfvars | `list(string)` | `[]` | no |
| <a name="input_quarantine_prefix"></a> [quarantine\_prefix](#input\_quarantine\_prefix) | S3 prefix for quarantined files | `string` | `null` | no |
| <a name="input_sns_topic_arn_for_threats"></a> [sns\_topic\_arn\_for\_threats](#input\_sns\_topic\_arn\_for\_threats) | SNS topic ARN to notify when THREATS\_FOUND. Can be overridden in terraform.tfvars | `string` | `null` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | Tags to apply to resources | `map(string)` | <pre>{<br/>  "Environment": "Production",<br/>  "Purpose": "SFTP Malware Protection"<br/>}</pre> | no |
| <a name="input_users_file"></a> [users\_file](#input\_users\_file) | Path to CSV file containing user definitions | `string` | `"users.csv"` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_clean_bucket_name"></a> [clean\_bucket\_name](#output\_clean\_bucket\_name) | Name of the created clean S3 bucket |
| <a name="output_error_bucket_name"></a> [error\_bucket\_name](#output\_error\_bucket\_name) | Name of the created error S3 bucket |
| <a name="output_guardduty_role_arn"></a> [guardduty\_role\_arn](#output\_guardduty\_role\_arn) | ARN of the GuardDuty IAM role |
| <a name="output_ingest_bucket_name"></a> [ingest\_bucket\_name](#output\_ingest\_bucket\_name) | The name of the S3 bucket used for SFTP storage |
| <a name="output_malware_protection_plan_arn"></a> [malware\_protection\_plan\_arn](#output\_malware\_protection\_plan\_arn) | ARN of the GuardDuty malware protection plan |
| <a name="output_quarantine_bucket_name"></a> [quarantine\_bucket\_name](#output\_quarantine\_bucket\_name) | Name of the created quarantine S3 bucket |
| <a name="output_quarantine_function_arn"></a> [quarantine\_function\_arn](#output\_quarantine\_function\_arn) | ARN of the quarantine Lambda function |
| <a name="output_sftp_server_endpoint"></a> [sftp\_server\_endpoint](#output\_sftp\_server\_endpoint) | SFTP server endpoint |
| <a name="output_sqs_queue_arn"></a> [sqs\_queue\_arn](#output\_sqs\_queue\_arn) | ARN of the SQS queue for GuardDuty events |
| <a name="output_test_user_details"></a> [test\_user\_details](#output\_test\_user\_details) | Map of test user with their details including secret names and ARNs |
| <a name="output_test_user_secret"></a> [test\_user\_secret](#output\_test\_user\_secret) | Map of users with their details including secret names and ARNs |
<!-- END_TF_DOCS -->