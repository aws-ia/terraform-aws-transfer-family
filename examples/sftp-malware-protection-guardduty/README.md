<!-- BEGIN_TF_DOCS -->
# SFTP Server with GuardDuty Malware Protection Example

This example demonstrates how to deploy an AWS Transfer Family SFTP server with integrated GuardDuty malware protection. It builds on top of the `sftp-public-endpoint-service-managed-S3` example and adds malware scanning capabilities. Files uploaded to the server are automatically scanned for malware and routed to appropriate destination buckets based on scan results.

## Architecture

This example uses a layered approach:

- **Base Infrastructure**: Leverages the `sftp-public-endpoint-service-managed-S3` example for core SFTP functionality
- **Malware Protection Layer**: Adds GuardDuty malware protection with automated file routing and malware detection alerts

## Key Features

- **SFTP Server**: Fully configured Transfer Family SFTP server with service-managed users (from base infrastructure)
- **Malware Protection**: GuardDuty malware protection plan for automatic file scanning
- **Smart Routing**: Files are automatically moved based on scan results:
  - Clean files (NO\_THREATS\_FOUND) → Clean bucket
  - Infected files (THREATS\_FOUND) → Quarantine bucket
  - Scan errors (UNSUPPORTED/ACCESS\_DENIED/FAILED)→ Error bucket
- **Event-Driven**: EventBridge and SQS integration for real-time malware detection response
- **Dead Letter Queue**: Enhanced error handling with DLQ for failed message processing
- **Threat Notifications**: SNS topic created by default for malware detection alerts
- **Secure Storage**: encrypted S3 buckets with public access blocking and optional versioning

**Note**: This example automatically creates an SNS topic for threat notifications. When malware is detected, notifications are sent to the topic `{random-pet-name}-malware-sns-topic`. Users can subscribe to this topic for email, SMS, or other notification methods.

## What Gets Deployed

### Base SFTP Infrastructure (from sftp-public-endpoint-service-managed-S3)

- AWS Transfer Family SFTP server (public endpoint)
- S3 bucket for file ingestion (with KMS encryption)
- Transfer users with SSH key authentication
- CloudWatch logging
- IAM roles and policies

### Malware Protection Components

- GuardDuty malware protection plan
- Lambda function for file quarantine and routing
- EventBridge rule for malware detection events
- SQS queue for event buffering (optional, default: `true`)
- SQS dead letter queue for failed message processing (optional, default: `false`)
- SNS topic for threat notifications
- Three additional S3 buckets:
  - Quarantine bucket (for infected files)
  - Clean bucket (for safe files)
  - Error bucket (for scan failures)

## File Flow

1. User uploads file to SFTP server → Ingestion bucket
2. GuardDuty automatically scans the file
3. Based on scan results, Lambda function moves file to:
  - **NO\_THREATS\_FOUND** → Clean bucket
  - **THREATS\_FOUND** → Quarantine bucket
  - **UNSUPPORTED/ACCESS\_DENIED/FAILED** → Error bucket

## Configuration Options

The example uses module defaults for most malware protection settings, which provide secure and reliable operation out of the box. You can customize behavior through these variables:

### File Organization

- **`clean_prefix`**, **`quarantine_prefix`**, **`error_prefix`** (default: `null`): Optional S3 prefixes for organizing files in destination buckets. When null, files are placed at the bucket root.
- **`object_prefixes_to_scan`** (default: `[]`): List of S3 object prefixes in the ingest bucket to scan for malware. Empty list scans all objects in the ingest bucket (corresponds to all user directories). Can be customized through variables to scan only specific directories.

## Module Configuration

The malware protection is configured using the `transfer-malware-protection` module,
check the `modules/transfer-malware-protection/README.md`for details.

### Module Defaults Used

The example leverages these module defaults for the following variables:

- **`delete_processed_file_from_ingest_bucket = false`**: Retains original files in ingestion bucket for audit purposes
- **`create_kms_key_for_lambda_sqs = false`**: Uses AWS managed keys for cost efficiency
- **`enable_sqs_buffer = true`**: Enables SQS buffering for improved reliability
- **`enable_object_tagging = true`**: GuardDuty automatically tags scanned objects with scan results

### Module Defaults Not Used

This example overrides these module defaults with custom configurations:

- **`name_prefix = "sftp-malware-protection"`**: Custom prefix for resources (module default: `"transfer-malware-protection"`)
- **`ingest_bucket_kms_key_arn`**: Configured with KMS key from base infrastructure (module default: `null`)
- **`sns_topic_arn_for_threats`**: Automatically configured with the created SNS topic for threat notifications (module default: `null`)
- **`tags`**: Set to example-specific tags (module default: `{}`)
- **`create_sqs_dlq = true`**: Creates dead letter queue for enhanced error handling (module default: `false`)
- **`routing_config`**: Configured with specific S3 bucket destinations for each scan result (module default: all `null`)

### Optional Features

Behavior can be customized by adding variables to `terraform.tfvars`. The examples below show non-default values for demonstration:

```hcl
# AWS Configuration
aws_region = "us-west-2"  # Deploy to different AWS region (default: us-east-1)

# User Management
users_file = "custom-users.csv"  # Use different CSV file for user definitions (default: users.csv)
create_test_user = false  # Skip creating test user (default: true)

# File Organization
clean_prefix = "clean/"  # Add prefix to clean files destination (default: null - root of bucket)
quarantine_prefix = "quarantine/"  # Add prefix to quarantined files (default: null - root of bucket)
error_prefix = "errors/"  # Add prefix to error files (default: null - root of bucket)

# Malware Protection Settings
sns_topic_arn_for_threats = "arn:aws:sns:us-east-1:123456789012:malware-alerts"  # Enable SNS notifications for malware detection (default: null - no notifications)
enable_object_tagging = false  # Disable GuardDuty automatic object tagging (default: true)
object_prefixes_to_scan = ["user1", "user2", "uploads"]  # Scan only specific directories (default: [] - scan all files)

# Resource Tagging
tags = {  # Override default tags
  Environment = "Development"
  Project     = "File Transfer"
  Owner       = "MyTeam"
}
```

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.5 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 5.95.0 |
| <a name="requirement_random"></a> [random](#requirement\_random) | >= 3.0.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 5.95.0 |
| <a name="provider_random"></a> [random](#provider\_random) | >= 3.0.0 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_guardduty_malware_protection"></a> [guardduty\_malware\_protection](#module\_guardduty\_malware\_protection) | ../../modules/transfer-malware-protection | n/a |
| <a name="module_s3_bucket_clean"></a> [s3\_bucket\_clean](#module\_s3\_bucket\_clean) | git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git | v5.0.0 |
| <a name="module_s3_bucket_errors"></a> [s3\_bucket\_errors](#module\_s3\_bucket\_errors) | git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git | v5.0.0 |
| <a name="module_s3_bucket_quarantine"></a> [s3\_bucket\_quarantine](#module\_s3\_bucket\_quarantine) | git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git | v5.0.0 |
| <a name="module_sftp-public-endpoint-service-managed-S3-resources"></a> [sftp-public-endpoint-service-managed-S3-resources](#module\_sftp-public-endpoint-service-managed-S3-resources) | ../sftp-public-endpoint-service-managed-S3 | n/a |

## Resources

| Name | Type |
|------|------|
| [aws_sns_topic.malware_threats](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sns_topic) | resource |
| [random_pet.name](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/pet) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_aws_region"></a> [aws\_region](#input\_aws\_region) | AWS region | `string` | `"us-east-1"` | no |
| <a name="input_clean_prefix"></a> [clean\_prefix](#input\_clean\_prefix) | S3 prefix for clean files | `string` | `null` | no |
| <a name="input_create_test_user"></a> [create\_test\_user](#input\_create\_test\_user) | Whether to create a test user | `bool` | `true` | no |
| <a name="input_error_prefix"></a> [error\_prefix](#input\_error\_prefix) | S3 prefix for error files | `string` | `null` | no |
| <a name="input_object_prefixes_to_scan"></a> [object\_prefixes\_to\_scan](#input\_object\_prefixes\_to\_scan) | List of S3 object prefixes to scan for malware. Empty list scans all objects. Can be overridden in terraform.tfvars | `list(string)` | `[]` | no |
| <a name="input_quarantine_prefix"></a> [quarantine\_prefix](#input\_quarantine\_prefix) | S3 prefix for quarantined files | `string` | `null` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | Tags to apply to resources | `map(string)` | <pre>{<br/>  "Environment": "Demo",<br/>  "Purpose": "SFTP Malware Protection"<br/>}</pre> | no |
| <a name="input_users_file"></a> [users\_file](#input\_users\_file) | Path to CSV file containing user definitions | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_clean_bucket_name"></a> [clean\_bucket\_name](#output\_clean\_bucket\_name) | Name of the created clean S3 bucket |
| <a name="output_error_bucket_name"></a> [error\_bucket\_name](#output\_error\_bucket\_name) | Name of the created error S3 bucket |
| <a name="output_file_transfer_function_arn"></a> [file\_transfer\_function\_arn](#output\_file\_transfer\_function\_arn) | ARN of the file transfer Lambda function |
| <a name="output_guardduty_role_arn"></a> [guardduty\_role\_arn](#output\_guardduty\_role\_arn) | ARN of the GuardDuty IAM role |
| <a name="output_ingest_bucket_name"></a> [ingest\_bucket\_name](#output\_ingest\_bucket\_name) | The name of the S3 bucket used for SFTP storage |
| <a name="output_malware_protection_plan_arn"></a> [malware\_protection\_plan\_arn](#output\_malware\_protection\_plan\_arn) | ARN of the GuardDuty malware protection plan |
| <a name="output_quarantine_bucket_name"></a> [quarantine\_bucket\_name](#output\_quarantine\_bucket\_name) | Name of the created quarantine S3 bucket |
| <a name="output_sftp_server_endpoint"></a> [sftp\_server\_endpoint](#output\_sftp\_server\_endpoint) | SFTP server endpoint |
| <a name="output_sns_topic_arn"></a> [sns\_topic\_arn](#output\_sns\_topic\_arn) | ARN of the SNS topic for malware threat notifications |
| <a name="output_sqs_queue_arn"></a> [sqs\_queue\_arn](#output\_sqs\_queue\_arn) | ARN of the SQS queue for GuardDuty events |
| <a name="output_test_user_details"></a> [test\_user\_details](#output\_test\_user\_details) | Map of test user with their details including secret names and ARNs |
| <a name="output_test_user_secret"></a> [test\_user\_secret](#output\_test\_user\_secret) | Map of users with their details including secret names and ARNs |
<!-- END_TF_DOCS -->