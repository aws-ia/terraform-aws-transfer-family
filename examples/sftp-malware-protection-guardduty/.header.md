# SFTP Server with GuardDuty Malware Protection Example

This example demonstrates how to deploy an AWS Transfer Family SFTP server with integrated GuardDuty malware protection. It builds on top of the `sftp-public-endpoint-service-managed-S3` example and adds malware scanning capabilities. Files uploaded to the server are automatically scanned for malware and routed to appropriate buckets based on scan results.

## Architecture

This example uses a layered approach:

- **Base Infrastructure**: Leverages the `sftp-public-endpoint-service-managed-S3` example for core SFTP functionality
- **Malware Protection Layer**: Adds GuardDuty malware protection with automated file routing

## Key Features

- **SFTP Server**: Fully configured Transfer Family SFTP server with service-managed users (from base infrastructure)
- **Malware Protection**: GuardDuty malware protection plan for automatic file scanning
- **Smart Routing**: Files are automatically moved based on scan results:
  - Clean files (NO_THREATS_FOUND) → Clean bucket
  - Infected files (THREATS_FOUND) → Quarantine bucket
  - Scan errors (UNSUPPORTED/ACCESS_DENIED/FAILED)→ Error bucket
- **Event-Driven**: EventBridge and SQS integration for real-time malware detection response
- **Secure Storage**: encrypted S3 buckets with public access blocking and optional versioning

**Note**: By default, no SNS topic is created or associated. To enable threat notifications, override by adding `sns_topic_arn_for_threats = "arn:aws:sns:region:account:topic/malware-alerts"` when creating the malware scanning module.

## What Gets Deployed

### Base SFTP Infrastructure (from sftp-public-endpoint-service-managed-S3)

- AWS Transfer Family SFTP server (public endpoint)
- S3 bucket for file ingestion (with KMS encryption)
- Transfer users with SSH key authentication
- CloudWatch logging
- IAM roles and policies

### Malware Protection Components

- GuardDuty malware protection plan
- Lambda function for file quarantine and routing
- EventBridge rule for malware detection events
- SQS queue for event buffering (optional, default: `true`)
- Three additional S3 buckets:
  - Quarantine bucket (for infected files)
  - Clean bucket (for safe files)
  - Error bucket (for scan failures)

## File Flow

1. User uploads file to SFTP server → Ingestion bucket
2. GuardDuty automatically scans the file
3. Based on scan results, Lambda function moves file to:
  - **NO_THREATS_FOUND** → Clean bucket
  - **THREATS_FOUND** → Quarantine bucket
  - **UNSUPPORTED/ACCESS_DENIED/FAILED** → Error bucket

## Configuration Options

The example uses module defaults for most malware protection settings, which provide secure and reliable operation out of the box. You can customize behavior through these variables:

### File Organization

- **`clean_prefix`**, **`quarantine_prefix`**, **`error_prefix`** (default: `null`): Optional S3 prefixes for organizing files in destination buckets. When null, files are placed at the bucket root.
- **`object_prefixes_to_scan`** (default: `[]`): List of S3 object prefixes in the ingest bucket to scan for malware. Empty list scans all objects in the ingest bucket (corresponds to all user directories). Can be customized through variables to scan only specific directories.

## Module Configuration

The malware protection is configured using the `transfer-malware-protection` module,
check the `modules/transfer-malware-protection/README.md`for details.

### Module Defaults Used

The example leverages these module defaults for the following variables:

- **`delete_processed_file_from_ingest_bucket = false`**: Retains original files in ingestion bucket for audit purposes
- **`create_kms_key_for_lambda_sqs = false`**: Uses AWS managed keys for cost efficiency
- **`create_sqs_dlq = false`**: Simplified error handling for basic use cases
- **`enable_sqs_buffer = true`**: Enables SQS buffering for improved reliability
- **`sns_topic_arn_for_threats = null`**: No SNS notifications by default (can be enabled via terraform.tfvars)
- **`enable_object_tagging = true`**: GuardDuty automatically tags scanned objects with scan results

### Optional Features

Users can customize behavior by adding variables to their `terraform.tfvars`. The examples below show non-default values for demonstration:

```hcl
# AWS Configuration
aws_region = "us-west-2"  # Deploy to different AWS region (default: us-east-1)

# User Management
users_file = "custom-users.csv"  # Use different CSV file for user definitions (default: users.csv)
create_test_user = false  # Skip creating test user (default: true)

# File Organization
clean_prefix = "clean/"  # Add prefix to clean files destination (default: null - root of bucket)
quarantine_prefix = "quarantine/"  # Add prefix to quarantined files (default: null - root of bucket)
error_prefix = "errors/"  # Add prefix to error files (default: null - root of bucket)

# Resource Naming
name_prefix = "my-sftp-malware-protection"  # Custom prefix for resources other than S3 buckets and those created as part of the base infrastructure (default: sftp-malware-protection)

# Malware Protection Settings
sns_topic_arn_for_threats = "arn:aws:sns:us-east-1:123456789012:malware-alerts"  # Enable SNS notifications for malware detection (default: null - no notifications)
enable_object_tagging = false  # Disable GuardDuty automatic object tagging (default: true)
object_prefixes_to_scan = ["user1", "user2", "uploads"]  # Scan only specific directories (default: [] - scan all files)

# Resource Tagging
tags = {  # Override default tags
  Environment = "Development"
  Project     = "File Transfer"
  Owner       = "MyTeam"
}
```
