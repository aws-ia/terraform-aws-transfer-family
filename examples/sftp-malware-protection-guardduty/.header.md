# SFTP Server with GuardDuty Malware Protection Example

This example demonstrates how to deploy an AWS Transfer Family SFTP server with integrated GuardDuty malware protection. It builds on top of the `sftp-public-endpoint-service-managed-S3` example and adds malware scanning capabilities. Files uploaded to the server are automatically scanned for malware and routed to appropriate buckets based on scan results.

## Architecture

This example uses a layered approach:
- **Base Infrastructure**: Leverages the `sftp-public-endpoint-service-managed-S3` example for core SFTP functionality
- **Malware Protection Layer**: Adds GuardDuty malware protection with automated file routing

## Key Features

- **SFTP Server**: Fully configured Transfer Family SFTP server with service-managed users (from base example)
- **Multiple Users**: Supports CSV-based user configuration with multiple SSH keys per user
- **Malware Protection**: GuardDuty malware protection plan for automatic file scanning
- **Smart Routing**: Files are automatically moved based on scan results:
  - Clean files (NO_THREATS_FOUND) → Clean bucket
  - Infected files (THREATS_FOUND) → Quarantine bucket  
  - Scan errors (UNSUPPORTED/ACCESS_DENIED/FAILED)→ Error bucket
- **Event-Driven**: EventBridge and SQS integration for real-time malware detection response
- **Secure Storage**: encrypted S3 buckets with public access blocking and optional versioning

## What Gets Deployed

### Base SFTP Infrastructure (from sftp-public-endpoint-service-managed-S3)
- AWS Transfer Family SFTP server (public endpoint)
- S3 bucket for file ingestion (with KMS encryption)
- Transfer users with SSH key authentication
- CloudWatch logging
- IAM roles and policies

### Malware Protection Components
- GuardDuty malware protection plan
- Lambda function for file quarantine and routing
- EventBridge rule for malware detection events
- SQS queue for event buffering (optional, default: `true`)
- Three additional S3 buckets:
  - Quarantine bucket (for infected files)
  - Clean bucket (for safe files)
  - Error bucket (for scan failures)

## File Flow

1. User uploads file to SFTP server → Ingestion bucket
2. GuardDuty automatically scans the file
3. Based on scan results, Lambda function moves file to:
   - **NO_THREATS_FOUND** → Clean bucket
   - **THREATS_FOUND** → Quarantine bucket
   - **UNSUPPORTED/ACCESS_DENIED/FAILED** → Error bucket

## Configuration Options

The example uses module defaults for most malware protection settings, which provide secure and reliable operation out of the box. You can customize behavior through these variables:

### File Organization
- **`clean_prefix`**, **`quarantine_prefix`**, **`error_prefix`** (default: `null`): Optional S3 prefixes for organizing files in destination buckets. When null, files are placed at the bucket root.

## Module Configuration

The malware protection is configured using the `transfer-malware-protection` module:

```hcl
module "guardduty_malware_protection" {
  source = "../../modules/transfer-malware-protection"

  # Required variables
  name_prefix = var.name_prefix
  s3_ingest_bucket = {
    bucket_name = module.sftp-public-endpoint-service-managed-S3-resources.sftp_bucket_name
    object_prefixes = concat(
      [for user in local.users : trimsuffix(trimprefix(user.home_dir, "/"), "/")],
      ["test_user"]
    )
  }

  # Optional variables (using module defaults)
  ingest_bucket_kms_key_arn = module.sftp-public-endpoint-service-managed-S3-resources.kms_key_arn
  tags                      = var.tags

  # Smart routing configuration
  routing_config = {
    "NO_THREATS_FOUND" = var.clean_prefix != null ? "${module.s3_bucket_clean.s3_bucket_id}/${var.clean_prefix}" : module.s3_bucket_clean.s3_bucket_id
    "THREATS_FOUND"    = var.quarantine_prefix != null ? "${module.s3_bucket_quarantine.s3_bucket_id}/${var.quarantine_prefix}" : module.s3_bucket_quarantine.s3_bucket_id
    "UNSUPPORTED"      = var.error_prefix != null ? "${module.s3_bucket_errors.s3_bucket_id}/${var.error_prefix}" : module.s3_bucket_errors.s3_bucket_id
    "ACCESS_DENIED"    = var.error_prefix != null ? "${module.s3_bucket_errors.s3_bucket_id}/${var.error_prefix}" : module.s3_bucket_errors.s3_bucket_id
    "FAILED"           = var.error_prefix != null ? "${module.s3_bucket_errors.s3_bucket_id}/${var.error_prefix}" : module.s3_bucket_errors.s3_bucket_id
  }

  depends_on = [module.sftp-public-endpoint-service-managed-S3-resources]
}
```

### Module Defaults Used

The example leverages these module defaults for the following variables:
- **`delete_processed_file_from_ingest_bucket = false`**: Retains original files in ingestion bucket for audit purposes
- **`create_kms_key_for_lambda_sqs = false`**: Uses AWS managed keys for cost efficiency
- **`create_sqs_dlq = false`**: Simplified error handling for basic use cases
- **`enable_sqs_buffer = true`**: Enables SQS buffering for improved reliability
