# AWS Transfer Family Terraform Module

This repository contains Terraform code which creates resources required to run a Transfer Family Server within AWS.


# AWS Transfer Family Terraform Modules

[![Terraform Version](https://img.shields.io/badge/Terraform-%3E%3D1.0-blue.svg)](https://www.terraform.io/)
[![AWS Provider Version](https://img.shields.io/badge/AWS%20Provider-%3E%3D4.0-orange.svg)](https://registry.terraform.io/providers/hashicorp/aws/latest)
[![License](https://img.shields.io/badge/License-Apache%202.0-green.svg)](./LICENSE)

## Overview

This repository contains Terraform modules for provisioning and managing AWS Transfer Family resources. These modules enable customers to implement Infrastructure-as-Code (IaC) for file transfer workflows between AWS storage locations (S3/EFS) and remote business partners over industry standard protocols (SFTP, AS2, FTPS, FTP).

The service provides fully managed server endpoints for remote clients to connect and upload/download files directly from S3, as well as fully managed connectors to interact with remote servers for sending or retrieving files directly into S3.

## Quick Start

```hcl
module "transfer_sftp" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-public-endpoint"
  
  identity_provider_type = "SERVICE_MANAGED"
  protocols             = ["SFTP"]
  domain               = "S3"
  
  tags = {
    Environment = "Dev"
    Project     = "File Transfer"
  }
}
```

## Architecture

### High-Level Architecture

![High-Level Architecture](./docs/images/high-level-architecture.png)

*Figure 1: High-level architecture of AWS Transfer Family deployment using these Terraform modules*

### Module Structure

![Module Structure](./docs/images/module-structure.png)

*Figure 2: Structure of the Terraform modules and their relationships*

### Deployment Scenarios

#### Public Endpoint Deployment

![Public Endpoint Deployment](./docs/images/public-endpoint-deployment.png)

*Figure 3: Deployment architecture for SFTP server with public endpoint*

#### Connector Workflow

![Connector Workflow](./docs/images/connector-workflow.png)

*Figure 5: Architecture of SFTP connector workflows*

## Features

- Deploy SFTP server endpoints with public endpoint type
- Deploy SFTP server endpoints with VPC endpoint using customer's existing VPC setups
- Configure SFTP connector workflows that run on a schedule to retrieve files from remote SFTP server to S3
- Set up SFTP connector workflows that use S3 events to trigger sending of files from S3 to remote SFTP server
- Provision AS2 resources (both server endpoint and connector)
- Support for custom hostnames and DNS configurations
- Integration with CloudWatch for logging and monitoring
- Support for managed workflows for file processing

## Prerequisites

- Terraform v1.0 or later
- AWS Provider v4.0 or later
- AWS CLI configured with appropriate permissions
- For VPC deployments:
  - Existing VPC with at least two subnets
  - Security groups configured for SFTP traffic (TCP port 22)
- For custom hostname:
  - Valid ACM certificate
  - Route 53 hosted zone

## Best Practices

- Always use VPC endpoints in production environments
- Implement proper logging and monitoring using CloudWatch
- Rotate SSH keys and credentials regularly
- Use service-managed users only for testing; implement custom IdP for production
- Follow the principle of least privilege when configuring IAM roles
- Enable AWS CloudTrail for auditing all API actions

## Modules

This repository includes the following modules:

### 1. SFTP Server with Public Endpoint

#### Module-1: Public SFTP Endpoint

- Creates a public SFTP server endpoint
- Configures security policies and logging
- Sets up optional custom hostname
- Supports both service-managed and custom identity providers

#### Module-2a: Service-Managed Users

- Creates service-managed users with HomeDirectory configuration
- Sets up IAM roles and permissions for S3 access
- Configures logical directories and session policies

#### Module-2b: Custom IdP Integration

- Deploys Transfer Family custom IdP solution
- Integrates with existing identity providers
- Supports various authentication methods (password, public key)

### 2. SFTP Server with VPC Endpoint

- Deploys SFTP server endpoints within a VPC
- Supports both internal and internet-facing access types
- Integrates with customer-provided VPC, subnets, and security groups
- Configures availability zones and subnet IDs
- Maintains the same user management options as the public endpoint module

### 3. SFTP Connector Workflows

#### Scheduled File Retrieval

- Deploys a Transfer Family SFTP connector
- Configures EventBridge schedules for automated file retrieval
- Sets up IAM permissions for S3 access
- Defines source and destination paths for file transfers

#### S3 Event-Triggered File Transfer

- Deploys a Transfer Family SFTP connector
- Configures S3 event notifications
- Sets up EventBridge rules to trigger file transfers
- Defines source and destination paths for file transfers

### 4. AS2 Resources

- Deploys AS2 server endpoints and connectors
- Configures certificates and security settings
- Sets up partner profiles and agreements
- Integrates with S3 for file storage

### 5. Web Apps (Future Enhancement)

- Provides web-based file transfer interfaces
- Integrates with existing Transfer Family resources

## Installation

To use these modules in your Terraform configuration:

1. Reference the modules in your Terraform code:

```hcl
module "transfer_server" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/transfer-server"
  
  # Module parameters
  # ...
}
```

2. Initialize your Terraform workspace:

```bash
terraform init
```

3. Review the planned changes:

```bash
terraform plan
```

4. Apply the configuration:

```bash
terraform apply
```

## Usage

### Basic Usage - Public SFTP Server

```hcl
module "sftp_public_endpoint" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-public-endpoint"
  
  identity_provider_type = "SERVICE_MANAGED"
  security_policy        = "TransferSecurityPolicy-2024-01"
  cloudwatch_log_group   = "transfer-family-logs"
  
  tags = {
    Environment = "Production"
    Project     = "FileTransfer"
  }
}

module "sftp_user" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-service-managed-user"
  
  home_directory          = "/${aws_s3_bucket.transfer_bucket.id}/home"
  s3_bucket_access_role_arn = aws_iam_role.transfer_role.arn
}
```

### VPC Endpoint SFTP Server

```hcl
module "sftp_vpc_endpoint" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-vpc-endpoint"
  
  vpc_id            = "vpc-12345678"
  subnet_ids        = ["subnet-12345678", "subnet-87654321"]
  security_group_id = "sg-12345678"
  access_type       = "INTERNET_FACING"
  
  # Additional parameters
  # ...
}
```
