# AWS Transfer Family Terraform Module

This repository contains Terraform code which creates resources required to run a Transfer Family Server within AWS.
<<<<<<< HEAD

# AWS Transfer Family Terraform Modules

![Terraform Version](https://img.shields.io/badge/Terraform-%3E%3D1.0.7-blue.svg)
[![AWS Provider Version](https://img.shields.io/badge/AWS%20Provider-%3E%3D5.83.0-orange.svg)](https://registry.terraform.io/providers/hashicorp/aws/latest)
[![License](https://img.shields.io/badge/License-Apache%202.0-green.svg)](./LICENSE)

## Overview

This module creates and configures an AWS Transfer Server with the following features:

- Basic Transfer Server setup with configurable protocols and security policies
- Custom hostname support through AWS Route53 or other DNS providers
- CloudWatch logging configuration with customizable retention
- Built-in validation checks for DNS and hostname configurations

## Quick Start

```hcl
module "transfer_sftp" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-public-endpoint"
  
  identity_provider_type = "SERVICE_MANAGED"
  protocols             = ["SFTP"]
  domain               = "S3"
  
  tags = {
    Environment = "Dev"
    Project     = "File Transfer"
  }
}
```

## Architecture

### High-Level Architecture

![High-Level Architecture](/Users/divvy/terraform_project/images/hlarch.png)

*Figure 1: High-level architecture of AWS Transfer Family deployment using this Terraform module*

## Features


### Transfer Server Configuration
- Deploy SFTP server endpoints with public endpoint type
- Server name customization (default: "transfer-server")
- S3 domain support
- SFTP protocol support
- Service-managed identity provider
- Support for custom hostnames and DNS configurations
- Integration with CloudWatch for logging and monitoring


### DNS Management
- Flexible DNS provider options (Route53 or other providers)
- Custom hostname configuration
- Route53 hosted zone integration
- Automatic CNAME record creation (when using Route53)

### Logging Features
- Optional CloudWatch logging
- Configurable log retention period (default: 30 days)
- Automated IAM role and policy configuration for logging
- AWS managed logging policy attachment

## Security Policy Support
Supports multiple AWS Transfer security policies including:
- Standard policies (2018-11 through 2024-01)
- FIPS-compliant policies
- PQ-SSH Experimental policies
- Restricted security policies

## Validation Checks

The module includes several built-in checks to ensure proper configuration:
- Route53 configuration validation
- Custom hostname verification
- DNS provider configuration checks
- Domain name compatibility verification
- Security policy name validation

## Prerequisites

- Terraform v1.0.7 or later
- AWS Provider v5.83.0 or later
- For custom hostname (based on the code):
  - If using Route53: A public Route53 hosted zone (seen in `data "aws_route53_zone"` with `private_zone = false`)
  - Custom hostname must be a subdomain of the hosted zone (enforced by the lifecycle precondition)


## Best Practices

- Enable CloudWatch logging for audit and monitoring purposes (optional, configurable via enable_logging variable)
- Use the latest security policies (default is TransferSecurityPolicy-2024-01, configurable with validation)
- Follow the principle of least privilege for logging IAM roles (using AWS managed policy AWSTransferLoggingAccess)
- Configure proper DNS settings when using custom hostnames (validated through check blocks)
- Utilize built-in validation checks for DNS provider and custom hostname configurations
- Use SERVICE_MANAGED identity provider (enforced through variable validation)
- Implement PUBLIC endpoint type (enforced through variable validation)
- Configure appropriate log retention period (default 30 days, customizable)
- Use proper tagging for resources (supported via tags variable)
  


## Modules

## Modules

This project utilizes multiple modules to create a complete AWS Transfer Family SFTP solution:

### Core Transfer Server Module (main module)
- Source: Local module (`../..`)
- Purpose: Creates and configures the AWS Transfer Server
- Key features:
  - SFTP protocol support
  - Public endpoint configuration
  - CloudWatch logging setup
  - Service-managed authentication
  - Custom hostname support (optional)

### S3 Bucket Module
- Source: `terraform-aws-modules/s3-bucket/aws` (version >= 3.5.0)
- Purpose: Creates secure S3 storage for SFTP server
- Key features:
  - KMS encryption enabled
  - Public access blocked
  - Versioning enabled
  - Bucket ownership controls
  - Server-side encryption configuration

### Transfer Users Module
- Source: `../../modules/transfer-users`
- Purpose: Manages SFTP user access and permissions
- Key features:
  - CSV-based user configuration support
  - Optional test user creation
  - IAM role and policy management
  - Integration with S3 bucket permissions
  - KMS encryption key access management


## Installation

To use these modules in your Terraform configuration:

1. Reference the modules in your Terraform code:

```hcl
module "transfer_server" {
  source = "https://github.com/aws-ia/terraform-aws-transfer-family"
  
  # Module parameters
  # ...
}
```

2. Initialize your Terraform workspace:

```bash
terraform init
```

3. Review the planned changes:

```bash
terraform plan
```

4. Apply the configuration:

```bash
terraform apply
```

## Basic Usage

### Simple SFTP Server Setup

```hcl
module "transfer_server" {
  source = "path/to/module"
  
  # Basic server configuration
  server_name       = "demo-transfer-server"
  domain           = "S3"
  protocols        = ["SFTP"]
  endpoint_type    = "PUBLIC"
  identity_provider = "SERVICE_MANAGED"
  
  # Enable logging
  enable_logging    = true
  log_retention_days = 14

  tags = {
    Environment = "Demo"
    Project     = "SFTP"
  }
}

# Required S3 bucket setup
module "s3_bucket" {
  source  = "terraform-aws-modules/s3-bucket/aws"
  version = ">=3.5.0"
  
  bucket = "my-sftp-storage-bucket"
  
  # Security settings
  block_public_acls        = true
  block_public_policy      = true
  ignore_public_acls       = true
  restrict_public_buckets  = true
  
  # Enable encryption
  server_side_encryption_configuration = {
    rule = {
      apply_server_side_encryption_by_default = {
        sse_algorithm = "aws:kms"
      }
    }
  }
}


=======


# AWS Transfer Family Terraform Modules

[![Terraform Version](https://img.shields.io/badge/Terraform-%3E%3D1.0-blue.svg)](https://www.terraform.io/)
[![AWS Provider Version](https://img.shields.io/badge/AWS%20Provider-%3E%3D4.0-orange.svg)](https://registry.terraform.io/providers/hashicorp/aws/latest)
[![License](https://img.shields.io/badge/License-Apache%202.0-green.svg)](./LICENSE)

## Overview

This repository contains Terraform modules for provisioning and managing AWS Transfer Family resources. These modules enable customers to implement Infrastructure-as-Code (IaC) for file transfer workflows between AWS storage locations (S3/EFS) and remote business partners over industry standard protocols (SFTP, AS2, FTPS, FTP).

The service provides fully managed server endpoints for remote clients to connect and upload/download files directly from S3, as well as fully managed connectors to interact with remote servers for sending or retrieving files directly into S3.

## Quick Start

```hcl
module "transfer_sftp" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-public-endpoint"
  
  identity_provider_type = "SERVICE_MANAGED"
  protocols             = ["SFTP"]
  domain               = "S3"
  
  tags = {
    Environment = "Dev"
    Project     = "File Transfer"
  }
}
```

## Architecture

### High-Level Architecture

![High-Level Architecture](./docs/images/high-level-architecture.png)

*Figure 1: High-level architecture of AWS Transfer Family deployment using these Terraform modules*

### Module Structure

![Module Structure](./docs/images/module-structure.png)

*Figure 2: Structure of the Terraform modules and their relationships*

### Deployment Scenarios

#### Public Endpoint Deployment

![Public Endpoint Deployment](./docs/images/public-endpoint-deployment.png)

*Figure 3: Deployment architecture for SFTP server with public endpoint*

#### Connector Workflow

![Connector Workflow](./docs/images/connector-workflow.png)

*Figure 5: Architecture of SFTP connector workflows*

## Features

- Deploy SFTP server endpoints with public endpoint type
- Deploy SFTP server endpoints with VPC endpoint using customer's existing VPC setups
- Configure SFTP connector workflows that run on a schedule to retrieve files from remote SFTP server to S3
- Set up SFTP connector workflows that use S3 events to trigger sending of files from S3 to remote SFTP server
- Provision AS2 resources (both server endpoint and connector)
- Support for custom hostnames and DNS configurations
- Integration with CloudWatch for logging and monitoring
- Support for managed workflows for file processing

## Prerequisites

- Terraform v1.0 or later
- AWS Provider v4.0 or later
- AWS CLI configured with appropriate permissions
- For VPC deployments:
  - Existing VPC with at least two subnets
  - Security groups configured for SFTP traffic (TCP port 22)
- For custom hostname:
  - Valid ACM certificate
  - Route 53 hosted zone

## Best Practices

- Always use VPC endpoints in production environments
- Implement proper logging and monitoring using CloudWatch
- Rotate SSH keys and credentials regularly
- Use service-managed users only for testing; implement custom IdP for production
- Follow the principle of least privilege when configuring IAM roles
- Enable AWS CloudTrail for auditing all API actions

## Modules

This repository includes the following modules:

### 1. SFTP Server with Public Endpoint

#### Module-1: Public SFTP Endpoint

- Creates a public SFTP server endpoint
- Configures security policies and logging
- Sets up optional custom hostname
- Supports both service-managed and custom identity providers

#### Module-2a: Service-Managed Users

- Creates service-managed users with HomeDirectory configuration
- Sets up IAM roles and permissions for S3 access
- Configures logical directories and session policies

#### Module-2b: Custom IdP Integration

- Deploys Transfer Family custom IdP solution
- Integrates with existing identity providers
- Supports various authentication methods (password, public key)

### 2. SFTP Server with VPC Endpoint

- Deploys SFTP server endpoints within a VPC
- Supports both internal and internet-facing access types
- Integrates with customer-provided VPC, subnets, and security groups
- Configures availability zones and subnet IDs
- Maintains the same user management options as the public endpoint module

### 3. SFTP Connector Workflows

#### Scheduled File Retrieval

- Deploys a Transfer Family SFTP connector
- Configures EventBridge schedules for automated file retrieval
- Sets up IAM permissions for S3 access
- Defines source and destination paths for file transfers

#### S3 Event-Triggered File Transfer

- Deploys a Transfer Family SFTP connector
- Configures S3 event notifications
- Sets up EventBridge rules to trigger file transfers
- Defines source and destination paths for file transfers

### 4. AS2 Resources

- Deploys AS2 server endpoints and connectors
- Configures certificates and security settings
- Sets up partner profiles and agreements
- Integrates with S3 for file storage

### 5. Web Apps (Future Enhancement)

- Provides web-based file transfer interfaces
- Integrates with existing Transfer Family resources

## Installation

To use these modules in your Terraform configuration:

1. Reference the modules in your Terraform code:

```hcl
module "transfer_server" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/transfer-server"
  
  # Module parameters
  # ...
}
```

2. Initialize your Terraform workspace:

```bash
terraform init
```

3. Review the planned changes:

```bash
terraform plan
```

4. Apply the configuration:

```bash
terraform apply
```

## Usage

### Basic Usage - Public SFTP Server

```hcl
module "sftp_public_endpoint" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-public-endpoint"
  
  identity_provider_type = "SERVICE_MANAGED"
  security_policy        = "TransferSecurityPolicy-2024-01"
  cloudwatch_log_group   = "transfer-family-logs"
  
  tags = {
    Environment = "Production"
    Project     = "FileTransfer"
  }
}

module "sftp_user" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-service-managed-user"
  
  home_directory          = "/${aws_s3_bucket.transfer_bucket.id}/home"
  s3_bucket_access_role_arn = aws_iam_role.transfer_role.arn
}
```

### VPC Endpoint SFTP Server

```hcl
module "sftp_vpc_endpoint" {
  source = "github.com/aws-samples/aws-transfer-family-terraform-modules//modules/sftp-vpc-endpoint"
  
  vpc_id            = "vpc-12345678"
  subnet_ids        = ["subnet-12345678", "subnet-87654321"]
  security_group_id = "sg-12345678"
  access_type       = "INTERNET_FACING"
  
  # Additional parameters
  # ...
}
```
>>>>>>> 9df45f1bd1085b8685e3e92c5428bd1f7f772815
